<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <title>Holiday Planner</title>
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
</head>

<body>
  <div class="container">
    <!-- <h1>Holiday planner</h1> -->
    <h1>Calcola ferie</h1>

    <form class="needs-validation" novalidate>
      <div class="form-group">
        <label for="countries">Nazione</label>
        <select class="form-control" id="countries" onchange="if (this.selectedIndex) fillYear();" required>
        </select>
      </div>
      <div class="form-group">
        <label for="years">Anno</label>
        <select class="form-control" id="years" required>
        </select>
      </div>
      <div class="form-group">
        <label for="leavedays">Giorni di ferie disponibili</label>
        <input type="number" class="form-control" id="leavedays" required>
      </div>
      <p>Working days:</p>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="monday" checked>
        <label class="form-check-label" for="monday">
          Monday
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="tuesday" checked>
        <label class="form-check-label" for="tuesday">
          Tuesday
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="wednesday" checked>
        <label class="form-check-label" for="wednesday">
          Wednesday
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="thursday" checked>
        <label class="form-check-label" for="thursday">
          Thursday
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="friday" checked>
        <label class="form-check-label" for="friday">
          Friday
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="saturday" >
        <label class="form-check-label" for="saturday">
          Saturday
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="sunday" >
        <label class="form-check-label" for="sunday">
          Sunday
        </label>
      </div>
      <br>
      <button type="submit" id="calculate" class="btn btn-primary" >Calcola</button>
    </form>

    <hr>

    <h2>Migliori possibilita':</h2>
    <div id="result"></div>

  </div>
  <script>
    function daysInYear(year) {
      return ((year % 4 === 0 && year % 100 > 0) || year % 400 == 0) ? 366 : 365;
    }

    function daysIntoYear(date) {
      return (Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()) - Date.UTC(date.getFullYear(), 0, 0)) / 24 / 60 / 60 / 1000;
    }

    function dateFromDay(year, day) {
      const date = new Date(year, 0);
      return new Date(date.setDate(day));
    }

    function groupBy(list, keyGetter) {
      const map = new Map();
      list.forEach((item) => {
        const key = keyGetter(item);
        const collection = map.get(key);
        if (!collection) {
          map.set(key, [item]);
        } else {
          collection.push(item);
        }
      });
      return map;
    }

    function findBestDays() {
      const countrySelection = document.getElementById("countries");
      const country = obj.holidaysPerCountry[countrySelection.value];

      const yearsDropdown = document.getElementById("years");
      const year = country.years[yearsDropdown.value];

      const leavedaysInput = document.getElementById("leavedays");

      let publicHolidaysDates = [];
      for (const publicHoliday of year.publicHolidays) {
        const datePublicHoliday = new Date(publicHoliday.day);
        publicHolidaysDates.push(datePublicHoliday);
      }
      const bestHolidays = best(year.year, publicHolidaysDates, leavedaysInput.value);
      const groupedHolidays = groupBy(bestHolidays, date => date.getMonth());

      // print bestholidays
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = '';
      for (const [monthIndex, dates] of groupedHolidays.entries()) {
        const month = new Date(year.year, monthIndex, 1);
        resultDiv.innerHTML += `<p class="font-weight-bold">${month.toLocaleString('default', { month: 'long' })}</p>`;

        const ul = document.createElement('ul');
        resultDiv.appendChild(ul);
        for (const day of dates) {
          const formattedDate = day.toLocaleString('default', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
          const li = document.createElement('li');
          li.appendChild(document.createTextNode(formattedDate));
          ul.appendChild(li);
        }

        let divRow = null;
        let divRowHeader = null;
        for (let i = 0; i < daysInMonth(month.getMonth() + 1, year.year); i++) {
          if (i % 7 == 0) {
            if (divRow != null && divRowHeader != null) {
              resultDiv.appendChild(divRowHeader);
              resultDiv.appendChild(divRow);
            }
            divRow = document.createElement('div');
            divRow.className = "row";
            divRowHeader = document.createElement('div');
            divRowHeader.className = "row";
          }
          const divCol = document.createElement('div');
          divCol.className = 'col border';
          const divColHeader = document.createElement('div');
          divColHeader.className = 'col bg-light border-top border-right border-left font-weight-bold';

          const currentDay = new Date(year.year, month.getMonth(), i + 1);

          // Set header text
          const shortWeekDay = currentDay.toLocaleString('default', {  weekday: 'short' });
          divColHeader.appendChild(document.createTextNode(shortWeekDay));
          divRowHeader.appendChild(divColHeader);

          if (dates.some((leaveDay) => leaveDay.getDate() - 1 === i)) {
            divCol.className += ' bg-danger text-white';
          }
          
          if (currentDay.getDay() == 0 || currentDay.getDay() == 6) {   //if Sunday or Saturday
            divCol.className += ' bg-primary text-white';
          }

          if (publicHolidaysDates.some((publicDay) => publicDay.getMonth() == currentDay.getMonth() && currentDay.getDate() == publicDay.getDate())) {
            divCol.className += ' bg-success text-white';
            divCol.setAttribute("data-toggle", "tooltip");
            divCol.setAttribute("data-placement", "top");
            const publicHoliday = publicHolidaysDates.find((publicDay) => publicDay.getMonth() == currentDay.getMonth() && currentDay.getDate() == publicDay.getDate());
            let descEn = "";
            for (const publicHolidayJson of year.publicHolidays) {
              const datePublicHoliday = new Date(publicHolidayJson.day);
              if(datePublicHoliday.getMonth() == publicHoliday.getMonth() && datePublicHoliday.getDate() == publicHoliday.getDate()){
                descEn = publicHolidayJson.description_en;
              } 
            }
            divCol.setAttribute("title",descEn);
          }
          divCol.appendChild(document.createTextNode(i + 1));
          divRow.appendChild(divCol);
        }

        if (divRow.hasChildNodes()) {
          const remaining = 7 - divRow.childNodes.length;
          for(let i = 0; i < remaining; i++){
            const divColHeader = document.createElement('div');
            divColHeader.className = 'col border-0';
            divRowHeader.appendChild(divColHeader);

            const divCol = document.createElement('div');
            divCol.className = 'col border-0';
            divRow.appendChild(divCol);
          }
          resultDiv.appendChild(divRowHeader);
          resultDiv.appendChild(divRow);
        }
      }
      const br = document.createElement('br');
      resultDiv.appendChild(br);
    }

    function daysInMonth(month, year) {
      return new Date(year, month, 0).getDate();
    }

    function allocate(yearAsArray, leaveDays) {
      const allocations = [];
      for (let i = 0; i < leaveDays; i++) {
        let slots = [];
        let slot = [-1, -1];
        for (let j = 0; j < yearAsArray.length; j++) {
          if (!yearAsArray[j] && slot[0] == -1) {
            slot[0] = j;
          }
          if (yearAsArray[j] && slot[0] != -1 && slot[1] == -1) {
            slot[1] = j - 1;
            slots.push([slot[0], slot[1], slot[1] - slot[0]]);
            slot = [-1, -1];
          }
        }
        if (slot[0] != -1 && slot[1] == -1) {
          slot[1] = yearAsArray.length - 1;
          slots.push(slot.slice());
        }

        // Sort pairs
        slots.sort(function (a, b) { return a[2] - b[2]; });

        //get first "smaller"
        const smallestSlot = slots[0];
        // get last day of such slot
        const bestDay = smallestSlot[1];
        // add to allocations
        allocations.push(bestDay);
        // set into yearsAsArray
        yearAsArray[bestDay] = true;
      }
      return allocations;
    }

    function best(year, publicHolidays, leaveDays) {
      // convert publicHolidays to dates
      // create array year
      const totDays = daysInYear(year);
      const yearAsArray = new Array(totDays).fill(false);
      // set all saturdays and sundays
      for (let i = 0; i < yearAsArray.length; i++) {
        const dateOfYear = dateFromDay(year, i + 1);
        if (dateOfYear.getDay() == 0 || dateOfYear.getDay() == 6) {   //if Sunday or Saturday
          yearAsArray[i] = true;
        }
      }
      // set all publicHolidays
      for (const day of publicHolidays) {
        const dayIndex = daysIntoYear(day) - 1;
        //console.log(`Public holiday ${day} is index ${dayIndex}`);
        yearAsArray[dayIndex] = true;
      }

      // fill best spots one by one
      const bestDays = allocate(yearAsArray, leaveDays);
      // Sort best days
      bestDays.sort(function (a, b) { return a - b; });
      //console.log(`Best days allocation: ${bestDays}`);

      // get list of dates from spots
      const bestHolidays = [];
      for (const day of bestDays) {
        const date = dateFromDay(year, day + 1);
        bestHolidays.push(date);
      }
      return bestHolidays;
    }

    function fillYear() {
      const countrySelection = document.getElementById("countries");
      const country = obj.holidaysPerCountry[countrySelection.value];

      const yearsDropdown = document.getElementById("years");
      yearsDropdown.innerHTML = '<option value="-1"></option>';
      for (let i = 0; i < country.years.length; i++) {
        let opt = document.createElement('option');
        opt.value = i;
        opt.innerHTML = country.years[i].year;
        yearsDropdown.appendChild(opt);
      }
    }

    const holidaysPerCountry = '{"holidaysPerCountry":[{"country":"Italy","years":[{"year":2021,"publicHolidays":[{"day":"2021-01-01","description_en":"New Year Day"},{"day":"2021-01-06","description_en":"Epiphany"},{"day":"2021-04-04","description_en":"Easter Sunday"},{"day":"2021-04-05","description_en":"Easter Monday"},{"day":"2021-04-25","description_en":"Liberation Day"},{"day":"2021-05-01","description_en":"International Workers Day"},{"day":"2021-06-02","description_en":"Republic Day"},{"day":"2021-08-15","description_en":"Assumption Day"},{"day":"2021-11-01","description_en":"All Saints Day"},{"day":"2021-12-08","description_en":"Immaculate Conception"},{"day":"2021-12-25","description_en":"Christmas Day"},{"day":"2021-12-26","description_en":"St Stephen Day"}]},{"year":2022,"publicHolidays":[{"day":"2022-01-01","description_en":"New Year Day"},{"day":"2022-01-06","description_en":"Epiphany"},{"day":"2022-04-17","description_en":"Easter Sunday"},{"day":"2022-04-18","description_en":"Easter Monday"},{"day":"2022-04-25","description_en":"Liberation Day"},{"day":"2022-05-01","description_en":"International Workers Day"},{"day":"2022-06-02","description_en":"Republic Day"},{"day":"2022-08-15","description_en":"Assumption Day, Ferragosto"},{"day":"2022-11-01","description_en":"All Saints Day"},{"day":"2022-12-08","description_en":"Immaculate Conception"},{"day":"2022-12-25","description_en":"Christmas Day"},{"day":"2022-12-26","description_en":"St Stephen Day"}]}]},{"country":"Taiwan","years":[{"year":2022,"publicHolidays":[{"day":"2022-01-01","description_en":"New Years Day"},{"day":"2022-01-29","description_en":"Chinese New Year"},{"day":"2022-01-30","description_en":"Chinese New Year"},{"day":"2022-01-31","description_en":"Chinese New Year"},{"day":"2022-02-01","description_en":"Chinese New Year"},{"day":"2022-02-02","description_en":"Chinese New Year"},{"day":"2022-02-03","description_en":"Chinese New Year"},{"day":"2022-02-04","description_en":"Chinese New Year"},{"day":"2022-02-05","description_en":"Chinese New Year"},{"day":"2022-02-06","description_en":"Chinese New Year"},{"day":"2022-02-28","description_en":"Peace Memorial Day"},{"day":"2022-04-04","description_en":"Children Day"},{"day":"2022-04-05","description_en":"Qingming Festival"},{"day":"2022-05-02","description_en":"Labour Day"},{"day":"2022-06-03","description_en":"Dragon Boat Festival"},{"day":"2022-09-10","description_en":"Mid-Autumn Festival"},{"day":"2022-10-10","description_en":"National Day"}]}]}]}';
    const obj = JSON.parse(holidaysPerCountry);

    $(document).ready(function () {

      $('[data-toggle="tooltip"]').tooltip();

      const countriesDropdown = document.getElementById("countries");
      countriesDropdown.innerHTML = '<option value="-1"></option>';
      for (let i = 0; i < obj.holidaysPerCountry.length; i++) {
        let opt = document.createElement('option');
        opt.value = i;
        opt.innerHTML = obj.holidaysPerCountry[i].country;
        countriesDropdown.appendChild(opt);
      }


      var forms = document.getElementsByClassName('needs-validation');
      // Loop over them and prevent submission
      var validation = Array.prototype.filter.call(forms, function (form) {
        form.addEventListener('submit', function (event) {
          event.preventDefault();
          if (form.checkValidity() === false) {
            event.stopPropagation();
          }
          else {
            findBestDays();
          }
          form.classList.add('was-validated');
        }, false);
      });
    });

  </script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NYVQZZ4CJD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-NYVQZZ4CJD');
  </script>
</body>

</html>